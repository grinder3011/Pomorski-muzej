<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Urejanje urnikov</title>
</head>
<body class="bg-gray-100 p-4 flex flex-col items-center">

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="w-full max-w-sm mt-10 bg-white shadow-md rounded-xl p-6">
    <h2 class="text-xl font-semibold mb-4 text-center">Prijava</h2>
    <label class="block mb-2">Uporabniško ime</label>
    <input id="username" class="w-full p-2 border rounded mb-4" placeholder="Vnesi uporabniško ime" />

    <label class="block mb-2">Geslo</label>
    <input id="password" type="password" class="w-full p-2 border rounded mb-6" placeholder="Vnesi geslo" />

    <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Prijava</button>
    <p id="loginMsg" class="text-red-600 mt-2"></p>
  </div>

  <!-- MAIN PAGE -->
  <div id="mainPage" class="hidden w-full max-w-4xl mt-10 bg-white shadow-md rounded-xl p-6">
    <h2 class="text-2xl font-bold mb-4">Urejanje urnikov</h2>

    <div id="scheduleDisplay" class="space-y-4"></div>

    <button id="editBtn" onclick="startEditing()" class="mt-4 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 hidden">Uredi urnik</button>

    <!-- Editor -->
    <div id="editor" class="hidden mt-6">
      <h3 class="text-xl font-semibold mb-4">Uredi obdobja</h3>
      <div id="periodList" class="space-y-4"></div>
      <button onclick="addPeriod()" class="mt-4 bg-blue-600 text-white py-2 px-4 rounded">Dodaj obdobje</button>

      <div class="flex gap-3 mt-6">
        <button onclick="cancelEditing()" class="flex-1 bg-gray-400 text-white py-2 rounded">Prekliči</button>
        <button onclick="saveChanges()" class="flex-1 bg-green-600 text-white py-2 rounded">Uporabi spremembe (samo za prikaz)</button>
      </div>
    </div>
  </div>

<script>
/* -----------------------
   Configuration / maps
   ----------------------- */
const dayNamesSlShort = {
  Mon: "Pon",
  Tue: "Tor",
  Wed: "Sre",
  Thu: "Čet",
  Fri: "Pet",
  Sat: "Sob",
  Sun: "Ned"
};

// current year used for date inputs (no year stored in JSON)
const currentYear = new Date().getFullYear();

/* -----------------------
   State
   ----------------------- */
let scheduleData = {};    // { "Location": { periods: [...] }, ... }
let originalData = null;  // deep copy for reset

/* -----------------------
   Login + load
   ----------------------- */
function login() {
  const user = document.getElementById('username').value;
  const pass = document.getElementById('password').value;
  const msg = document.getElementById('loginMsg');

  if (user === 'admin' && pass === 'admin') {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    loadJSON();
  } else {
    msg.textContent = 'Neveljavni podatki (uporabite admin/admin).';
  }
}

function loadJSON() {
  fetch('status-muzeja/schedules.json')
    .then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(data => {
      // existing JSON has structure { locations: { ... } }
      scheduleData = JSON.parse(JSON.stringify(data.locations || {}));
      originalData = JSON.parse(JSON.stringify(scheduleData));
      renderSchedule();
      document.getElementById('editBtn').classList.remove('hidden');
    })
    .catch(err => {
      console.error('Napaka pri nalaganju JSON:', err);
      document.getElementById('scheduleDisplay').textContent = 'Napaka pri nalaganju urnikov.';
    });
}

/* -----------------------
   Preview rendering (Slovenian day names)
   ----------------------- */
function renderSchedule() {
  const container = document.getElementById('scheduleDisplay');
  container.innerHTML = '';

  Object.entries(scheduleData).forEach(([loc, locData]) => {
    const card = document.createElement('div');
    card.className = 'border rounded p-4 bg-gray-50';

    const title = document.createElement('h3');
    title.className = 'font-semibold text-lg mb-2';
    title.textContent = loc;
    card.appendChild(title);

    (locData.periods || []).forEach((p, idx) => {
      const periodDiv = document.createElement('div');
      periodDiv.className = 'border p-2 rounded mb-2 bg-white';
      periodDiv.innerHTML = `<strong>Obdobje ${idx+1}:</strong> ${p.start || '—'} - ${p.end || '—'}`;

      const ul = document.createElement('ul');
      for (const dayKey of ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']) {
        const li = document.createElement('li');
        const val = p.hours ? p.hours[dayKey] : null;
        const display = Array.isArray(val) ? val.join(', ') : (val || 'Zaprto');
        li.textContent = `${dayNamesSlShort[dayKey]}: ${display}`;
        ul.appendChild(li);
      }
      periodDiv.appendChild(ul);
      card.appendChild(periodDiv);
    });

    container.appendChild(card);
  });
}

/* -----------------------
   Editor
   ----------------------- */
function startEditing() {
  const editor = document.getElementById('editor');
  const list = document.getElementById('periodList');
  list.innerHTML = '';

  Object.entries(scheduleData).forEach(([loc, locData]) => {
    const locCard = document.createElement('div');
    locCard.className = 'border rounded p-3 bg-gray-100';

    const title = document.createElement('h4');
    title.className = 'font-semibold mb-2';
    title.textContent = loc;
    locCard.appendChild(title);

    (locData.periods || []).forEach((p, idx) => {
      const periodDiv = createPeriodForm(loc, idx, p);
      locCard.appendChild(periodDiv);
    });

    // add button for location
    const addBtn = document.createElement('button');
    addBtn.textContent = 'Dodaj obdobje';
    addBtn.className = 'mt-2 bg-blue-500 text-white px-3 py-1 rounded';
    addBtn.onclick = () => {
      const newPeriod = { start: '', end: '', hours: { Mon:null,Tue:null,Wed:null,Thu:null,Fri:null,Sat:null,Sun:null } };
      scheduleData[loc].periods.push(newPeriod);
      // insert before button
      locCard.insertBefore(createPeriodForm(loc, scheduleData[loc].periods.length-1, newPeriod), addBtn);
      sortPeriods(loc);
    };
    locCard.appendChild(addBtn);

    list.appendChild(locCard);
  });

  editor.classList.remove('hidden');
}

/* Convert MM-DD (string) to input[type=date] value YYYY-MM-DD */
function mmddToDateValue(mmdd) {
  if (!mmdd || !/^\d{2}-\d{2}$/.test(mmdd)) return '';
  return `${currentYear}-${mmdd}`;
}
function dateValueToMmdd(v) {
  if (!v || v.length < 10) return '';
  return v.slice(5); // "YYYY-MM-DD" -> "MM-DD"
}

/* Create a period editor block */
function createPeriodForm(loc, idx, periodData) {
  const div = document.createElement('div');
  div.className = 'border p-2 rounded mb-2 bg-white';

  // Header row: start (datepicker + mm-dd), end (datepicker + mm-dd), remove
  const header = document.createElement('div');
  header.className = 'flex flex-col md:flex-row gap-2 items-start md:items-center';

  // Start controls
  const startWrap = document.createElement('div');
  startWrap.className = 'flex flex-col sm:flex-row gap-2 items-center';
  const startLabel = document.createElement('label'); startLabel.className = 'font-medium'; startLabel.textContent = 'Začetek:';
  const startDate = document.createElement('input');
  startDate.type = 'date';
  startDate.className = 'border p-1 rounded';
  startDate.value = mmddToDateValue(periodData.start);
  const startText = document.createElement('input');
  startText.type = 'text';
  startText.placeholder = 'MM-DD';
  startText.value = periodData.start || '';
  startText.className = 'border p-1 rounded w-24';
  // sync datepicker -> text
  startDate.onchange = (e) => {
    const mmdd = dateValueToMmdd(e.target.value);
    periodData.start = mmdd;
    startText.value = mmdd;
    // keep periods sorted after change
    sortPeriods(loc);
  };
  // sync text -> datepicker (accept only MM-DD)
  startText.onchange = (e) => {
    const v = e.target.value.trim();
    if (/^\d{2}-\d{2}$/.test(v)) {
      periodData.start = v;
      startDate.value = mmddToDateValue(v);
      sortPeriods(loc);
    } else {
      // accept empty to clear, otherwise revert to previous
      if (v === '') {
        periodData.start = '';
        startDate.value = '';
      } else {
        alert('Vnesite datum v formatu MM-DD (npr. 07-01) ali uporabite koledar.');
        startText.value = periodData.start || '';
      }
    }
  };
  startWrap.appendChild(startLabel);
  startWrap.appendChild(startDate);
  startWrap.appendChild(startText);

  // End controls
  const endWrap = document.createElement('div');
  endWrap.className = 'flex flex-col sm:flex-row gap-2 items-center';
  const endLabel = document.createElement('label'); endLabel.className = 'font-medium'; endLabel.textContent = 'Konec:';
  const endDate = document.createElement('input');
  endDate.type = 'date';
  endDate.className = 'border p-1 rounded';
  endDate.value = mmddToDateValue(periodData.end);
  const endText = document.createElement('input');
  endText.type = 'text';
  endText.placeholder = 'MM-DD';
  endText.value = periodData.end || '';
  endText.className = 'border p-1 rounded w-24';
  endDate.onchange = (e) => {
    const mmdd = dateValueToMmdd(e.target.value);
    periodData.end = mmdd;
    endText.value = mmdd;
    sortPeriods(loc);
  };
  endText.onchange = (e) => {
    const v = e.target.value.trim();
    if (/^\d{2}-\d{2}$/.test(v)) {
      periodData.end = v;
      endDate.value = mmddToDateValue(v);
      sortPeriods(loc);
    } else {
      if (v === '') {
        periodData.end = '';
        endDate.value = '';
      } else {
        alert('Vnesite datum v formatu MM-DD (npr. 08-31) ali uporabite koledar.');
        endText.value = periodData.end || '';
      }
    }
  };
  endWrap.appendChild(endLabel);
  endWrap.appendChild(endDate);
  endWrap.appendChild(endText);

  // Remove period button
  const removeBtn = document.createElement('button');
  removeBtn.textContent = 'Odstrani obdobje';
  removeBtn.className = 'ml-auto bg-red-500 text-white px-3 py-1 rounded';
  removeBtn.onclick = () => {
    const arr = scheduleData[loc].periods;
    const i = arr.indexOf(periodData);
    if (i >= 0) {
      arr.splice(i, 1);
      div.remove();
    } else {
      div.remove();
    }
  };

  const topRow = document.createElement('div');
  topRow.className = 'flex gap-3 w-full items-center';
  topRow.appendChild(startWrap);
  topRow.appendChild(endWrap);
  topRow.appendChild(removeBtn);

  div.appendChild(topRow);

  // Hours table (Mon..Sun) — each row has structured inputs for single or two ranges
  const hoursBox = document.createElement('div');
  hoursBox.className = 'mt-3 space-y-2';

  const dayKeys = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  dayKeys.forEach(dayKey => {
    const row = document.createElement('div');
    row.className = 'flex flex-col md:flex-row md:items-center gap-2';

    const lbl = document.createElement('div');
    lbl.className = 'w-20 font-medium';
    lbl.textContent = dayNamesSlShort[dayKey] + ':';

    const rangesWrap = document.createElement('div');
    rangesWrap.className = 'flex gap-2 flex-wrap items-center flex-1';

    // ensure value is normalized: either null, string single, or array
    const v = periodData.hours && periodData.hours[dayKey] !== undefined ? periodData.hours[dayKey] : null;
    const ranges = (v === null || v === undefined) ? [] : (Array.isArray(v) ? v.slice() : [v]);

    // function to add a pair of time inputs
    function addRangePair(initial = '') {
      // parse initial which may be "HH:MM-HH:MM" or empty
      let fromVal = '', toVal = '';
      if (initial && /^\\d{2}:\\d{2}-\\d{2}:\\d{2}$/.test(initial)) {
        const parts = initial.split('-');
        fromVal = parts[0];
        toVal = parts[1];
      }

      const pair = document.createElement('div');
      pair.className = 'flex gap-1 items-center';

      const from = document.createElement('input');
      from.type = 'time'; from.className = 'border p-1 rounded'; from.value = fromVal;
      const dash = document.createElement('span'); dash.textContent = '–';
      const to = document.createElement('input');
      to.type = 'time'; to.className = 'border p-1 rounded'; to.value = toVal;

      const removeRange = document.createElement('button');
      removeRange.className = 'ml-2 bg-red-400 text-white px-2 py-1 rounded';
      removeRange.textContent = 'X';

      // when either changes, update periodData.hours[dayKey]
      function updateBacking() {
        const vals = [...rangesWrap.querySelectorAll('input[type=time]')]
          // group by twos
          .reduce((acc, el, i) => {
            const pairIndex = Math.floor(i/2);
            acc[pairIndex] = acc[pairIndex] || [];
            acc[pairIndex].push(el.value);
            return acc;
          }, [])
          .map(pair => pair.join('-'))
          .filter(pair => pair && pair !== '-');

        // if none -> null
        periodData.hours[dayKey] = vals.length === 0 ? null : (vals.length === 1 ? vals[0] : vals);
      }

      removeRange.onclick = () => {
        pair.remove();
        updateBacking();
      };

      from.onchange = updateBacking;
      to.onchange = updateBacking;

      pair.appendChild(from);
      pair.appendChild(dash);
      pair.appendChild(to);
      pair.appendChild(removeRange);

      rangesWrap.appendChild(pair);
      updateBacking();
    }

    // populate existing ranges
    if (ranges.length === 0) {
      // nothing -> show one empty pair by default for convenience
      addRangePair('');
    } else {
      ranges.forEach(r => {
        addRangePair(r);
      });
    }

    const addBtn = document.createElement('button');
    addBtn.className = 'ml-2 bg-blue-400 text-white px-2 py-1 rounded';
    addBtn.textContent = '+';
    addBtn.onclick = () => addRangePair('');

    row.appendChild(lbl);
    row.appendChild(rangesWrap);
    row.appendChild(addBtn);

    hoursBox.appendChild(row);
  });

  div.appendChild(hoursBox);

  return div;
}

/* Sort periods within a location by start MM-DD (empty at end) */
function sortPeriods(loc) {
  const arr = scheduleData[loc].periods;
  arr.sort((a,b) => {
    if (!a.start && !b.start) return 0;
    if (!a.start) return 1;
    if (!b.start) return -1;
    // 'MM-DD' lexicographic sorts correctly as 'MM-DD'
    return a.start.localeCompare(b.start);
  });
  renderSchedule(); // reflect immediately in preview
}

/* -----------------------
   Cancel / Save (mock)
   ----------------------- */
function cancelEditing() {
  // restore from originalData
  scheduleData = JSON.parse(JSON.stringify(originalData));
  document.getElementById('editor').classList.add('hidden');
  renderSchedule();
}

function saveChanges() {
  // apply and update originalData (mock save only)
  originalData = JSON.parse(JSON.stringify(scheduleData));
  // optionally sort all locations
  Object.keys(scheduleData).forEach(loc => sortPeriods(loc));
  renderSchedule();
  alert('Spremembe uporabljene (samo za prikaz, še niso shranjene).');
  document.getElementById('editor').classList.add('hidden');
}

/* -----------------------
   Utility: add a new blank period for first location when needed
   ----------------------- */
function addPeriod() {
  // if multiple locations, add to first one (rare). Better UX later: choose location.
  const firstLoc = Object.keys(scheduleData)[0];
  if (!firstLoc) {
    alert('Ni lokacij v podatkih (ne morem dodati obdobja).');
    return;
  }
  const newPeriod = { start:'', end:'', hours:{ Mon:null,Tue:null,Wed:null,Thu:null,Fri:null,Sat:null,Sun:null } };
  scheduleData[firstLoc].periods.push(newPeriod);
  startEditing(); // rebuild editor to include the new period
}

</script>
</body>
</html>
