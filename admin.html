<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Urejanje urnikov</title>
</head>
<body class="bg-gray-100 p-4 flex flex-col items-center">

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="w-full max-w-sm mt-10 bg-white shadow-md rounded-xl p-6">
    <h2 class="text-xl font-semibold mb-4 text-center">Prijava</h2>
    <label class="block mb-2">Uporabniško ime</label>
    <input id="username" class="w-full p-3 border rounded mb-4" placeholder="Vnesi uporabniško ime" />

    <label class="block mb-2">Geslo</label>
    <input id="password" type="password" class="w-full p-3 border rounded mb-6" placeholder="Vnesi geslo" />

    <button onclick="login()" class="w-full bg-blue-600 text-white py-3 rounded hover:bg-blue-700">Prijava</button>
    <p id="loginMsg" class="text-red-600 mt-2"></p>
  </div>

  <!-- MAIN PAGE -->
  <div id="mainPage" class="hidden w-full max-w-4xl mt-10 bg-white shadow-md rounded-xl p-6">
    <h2 class="text-2xl font-bold mb-4">Urejanje urnikov</h2>

    <div id="scheduleDisplay" class="space-y-6"></div>

    <button id="editBtn" onclick="startEditing()" class="mt-4 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 hidden">Uredi urnik</button>

    <!-- Editor -->
    <div id="editor" class="hidden mt-6">
      <h3 class="text-xl font-semibold mb-4">Uredi obdobja</h3>
      <div id="periodList" class="space-y-4"></div>
      <button onclick="addPeriod()" class="mt-4 bg-blue-600 text-white py-2 px-4 rounded">Dodaj obdobje</button>

      <div class="flex flex-col sm:flex-row gap-3 mt-6">
        <button onclick="cancelEditing()" class="flex-1 bg-gray-400 text-white py-2 rounded">Prekliči</button>
        <button onclick="saveChanges()" class="flex-1 bg-green-600 text-white py-2 rounded">Uporabi spremembe (samo za prikaz)</button>
      </div>
    </div>
  </div>

<script>
let scheduleData = {};
let originalData = null;
const dayNames = {Mon:'Ponedeljek',Tue:'Torek',Wed:'Sreda',Thu:'Četrtek',Fri:'Petek',Sat:'Sobota',Sun:'Nedelja'};

function login() {
  const user = document.getElementById('username').value;
  const pass = document.getElementById('password').value;
  const msg = document.getElementById('loginMsg');

  if (user === 'admin' && pass === 'admin') {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    loadJSON();
  } else {
    msg.textContent = 'Neveljavni podatki (uporabite admin/admin).';
  }
}

function loadJSON() {
  fetch('status-muzeja/schedules.json')
    .then(r => r.json())
    .then(data => {
      scheduleData = JSON.parse(JSON.stringify(data.locations));
      originalData = JSON.parse(JSON.stringify(scheduleData));
      renderSchedule();
      document.getElementById('editBtn').classList.remove('hidden');
    })
    .catch(err => {
      console.error('Napaka pri nalaganju JSON:', err);
      document.getElementById('scheduleDisplay').textContent = 'Napaka pri nalaganju urnikov.';
    });
}

function renderSchedule() {
  const container = document.getElementById('scheduleDisplay');
  container.innerHTML = '';

  Object.entries(scheduleData).forEach(([loc, locData]) => {
    const card = document.createElement('div');
    card.className = 'border rounded p-4 bg-gray-50';

    const title = document.createElement('h3');
    title.className = 'font-semibold text-lg mb-2';
    title.textContent = loc;
    card.appendChild(title);

    locData.periods.forEach((p, idx) => {
      const periodDiv = document.createElement('div');
      periodDiv.className = 'border p-2 rounded mb-2 bg-white';

      // Add spacing between period line and weekdays
      periodDiv.innerHTML = `<strong>Obdobje ${idx+1}: ${p.start} - ${p.end}</strong><br><br>`;

      const ul = document.createElement('ul');
      for (const day in p.hours) {
        const li = document.createElement('li');
        li.textContent = `${dayNames[day]}: ${Array.isArray(p.hours[day]) ? p.hours[day].join(', ') : (p.hours[day] || 'Zaprto')}`;
        ul.appendChild(li);
      }
      periodDiv.appendChild(ul);
      card.appendChild(periodDiv);
    });

    container.appendChild(card);
  });
}

function startEditing() {
  const editor = document.getElementById('editor');
  const list = document.getElementById('periodList');
  list.innerHTML = '';

  Object.entries(scheduleData).forEach(([loc, locData]) => {
    const locCard = document.createElement('div');
    locCard.className = 'border rounded p-3 bg-gray-100 relative';

    const title = document.createElement('h4');
    title.className = 'font-semibold mb-2';
    title.textContent = loc;
    locCard.appendChild(title);

    locData.periods.forEach((p, idx) => {
      const periodDiv = createPeriodForm(loc, idx, p);
      locCard.appendChild(periodDiv);
    });

    list.appendChild(locCard);
  });

  editor.classList.remove('hidden');
}

function createPeriodForm(loc, idx, periodData) {
  const div = document.createElement('div');
  div.className = 'border p-2 rounded mb-2 bg-white relative';

  // Odstrani obdobje button top
  const removeBtn = document.createElement('button');
  removeBtn.textContent = 'Odstrani obdobje';
  removeBtn.className = 'absolute top-0 left-0 right-0 bg-red-500 text-white py-2 rounded-t text-center';
  removeBtn.onclick = () => { 
    scheduleData[loc].periods.splice(idx,1); 
    div.remove(); 
  };
  div.appendChild(removeBtn);

  // Date pickers with helper text
  const dateDiv = document.createElement('div');
  dateDiv.className = 'flex flex-col sm:flex-row gap-2 items-center mb-2 mt-8';
  const startLabel = document.createElement('span');
  startLabel.textContent = 'Obdobje od';
  startLabel.className='font-medium';
  dateDiv.appendChild(startLabel);

  const startInput = document.createElement('input');
  startInput.type='date';
  startInput.className='border p-1 rounded flex-1';
  if(periodData.start) startInput.value = '2025-' + periodData.start;
  startInput.onchange = e => periodData.start = e.target.value ? e.target.value.slice(5) : '';
  dateDiv.appendChild(startInput);

  const toLabel = document.createElement('span');
  toLabel.textContent = 'do';
  toLabel.className='mx-2 font-medium';
  dateDiv.appendChild(toLabel);

  const endInput = document.createElement('input');
  endInput.type='date';
  endInput.className='border p-1 rounded flex-1';
  if(periodData.end) endInput.value = '2025-' + periodData.end;
  endInput.onchange = e => periodData.end = e.target.value ? e.target.value.slice(5) : '';
  dateDiv.appendChild(endInput);

  div.appendChild(dateDiv);

  // Days with responsive start-end inputs
  Object.keys(periodData.hours).forEach(day => {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'flex flex-col sm:flex-row sm:items-center gap-2 mt-1';
    
    const label = document.createElement('span');
    label.textContent = dayNames[day]+':';
    label.className = 'w-24 flex-shrink-0';
    dayDiv.appendChild(label);

    let ranges = Array.isArray(periodData.hours[day]) ? periodData.hours[day] : periodData.hours[day] ? [periodData.hours[day]] : [];

    ranges.forEach((range, i) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'flex gap-1 sm:gap-2 flex-1 flex-wrap';
      
      const inputStart = document.createElement('input');
      inputStart.type='time';
      inputStart.value = range ? range.split('-')[0] : '';
      inputStart.className='border p-1 rounded flex-1 min-w-0';
      
      const inputEnd = document.createElement('input');
      inputEnd.type='time';
      inputEnd.value = range ? range.split('-')[1] : '';
      inputEnd.className='border p-1 rounded flex-1 min-w-0';
      
      inputStart.onchange = inputEnd.onchange = () => {
        const startVal = inputStart.value;
        const endVal = inputEnd.value;
        ranges[i] = startVal && endVal ? `${startVal}-${endVal}` : '';
        periodData.hours[day] = ranges.length === 1 ? ranges[0] : ranges;
      };
      wrapper.appendChild(inputStart);
      wrapper.appendChild(inputEnd);
      dayDiv.appendChild(wrapper);
    });

    if(ranges.length < 2){
      const addRangeBtn = document.createElement('button');
      addRangeBtn.textContent = '+';
      addRangeBtn.className = 'bg-blue-500 text-white px-2 py-1 rounded';
      addRangeBtn.onclick = () => {
        if(ranges.length < 2){
          ranges.push('');
          periodData.hours[day] = ranges.length === 1 ? ranges[0] : ranges;
          const newInputs = createNewTimeInputs(dayDiv, ranges, ranges.length-1, periodData, day);
          dayDiv.insertBefore(newInputs, addRangeBtn);
          if(ranges.length === 2) addRangeBtn.style.display='none';
        }
      };
      dayDiv.appendChild(addRangeBtn);
    }

    div.appendChild(dayDiv);
  });

  return div;
}

function createNewTimeInputs(dayDiv, ranges, index, periodData, day){
  const wrapper = document.createElement('div');
  wrapper.className='flex gap-1 sm:gap-2 flex-1 flex-wrap';
  
  const inputStart = document.createElement('input');
  inputStart.type='time';
  inputStart.className='border p-1 rounded flex-1 min-w-0';
  
  const inputEnd = document.createElement('input');
  inputEnd.type='time';
  inputEnd.className='border p-1 rounded flex-1 min-w-0';
  
  inputStart.onchange = inputEnd.onchange = () => {
    const startVal = inputStart.value;
    const endVal = inputEnd.value;
    ranges[index] = startVal && endVal ? `${startVal}-${endVal}` : '';
    periodData.hours[day] = ranges.length === 1 ? ranges[0] : ranges;
  };
  
  wrapper.appendChild(inputStart);
  wrapper.appendChild(inputEnd);
  return wrapper;
}

function cancelEditing() {
  document.getElementById('editor').classList.add('hidden');
}

function saveChanges() {
  renderSchedule();
  alert('Spremembe uporabljene (samo za prikaz, še niso shranjene).');
  cancelEditing();
}
</script>
</body>
</html>
