<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<title>Urejanje urnikov</title>
</head>
<body class="bg-gray-100 p-4 flex flex-col items-center">

<!-- LOGIN PAGE -->
<div id="loginPage" class="w-full max-w-sm mt-10 bg-white shadow-md rounded-xl p-6">
  <h2 class="text-xl font-semibold mb-4 text-center">Prijava</h2>
  <label class="block mb-2">Uporabniško ime</label>
  <input id="username" class="w-full p-2 border rounded mb-4" placeholder="Vnesi uporabniško ime" />
  <label class="block mb-2">Geslo</label>
  <input id="password" type="password" class="w-full p-2 border rounded mb-6" placeholder="Vnesi geslo" />
  <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Prijava</button>
  <p id="loginMsg" class="text-red-600 mt-2"></p>
</div>

<!-- MAIN PAGE -->
<div id="mainPage" class="hidden w-full max-w-4xl mt-10 bg-white shadow-md rounded-xl p-6">
  <h2 class="text-2xl font-bold mb-4">Urejanje urnikov</h2>
  <div id="scheduleDisplay" class="space-y-4"></div>
  <button id="editBtn" onclick="startEditing()" class="mt-4 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 hidden">Uredi urnik</button>

  <!-- Editor -->
  <div id="editor" class="hidden mt-6">
    <h3 class="text-xl font-semibold mb-2">Uredi obdobja</h3>
    <p class="text-gray-600 mb-2">Izberi ali vpiši datum za vsako obdobje</p>
    <div id="periodList" class="space-y-4"></div>
    <div class="flex gap-3 mt-6 flex-col sm:flex-row">
      <button onclick="cancelEditing()" class="flex-1 bg-gray-400 text-white py-2 rounded">Prekliči</button>
      <button onclick="saveChanges()" class="flex-1 bg-green-600 text-white py-2 rounded">Uporabi spremembe (samo za prikaz)</button>
    </div>
  </div>
</div>

<script>
const dayNames = {Mon:'Pon',Tue:'Tor',Wed:'Sre',Thu:'Čet',Fri:'Pet',Sat:'Sob',Sun:'Ned'};
let scheduleData = {};
let originalData = null;

function login() {
  const user = document.getElementById('username').value;
  const pass = document.getElementById('password').value;
  const msg = document.getElementById('loginMsg');
  if(user==='admin'&&pass==='admin'){
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    loadJSON();
  } else {
    msg.textContent='Neveljavni podatki (uporabite admin/admin).';
  }
}

function loadJSON(){
  fetch('status-muzeja/schedules.json')
    .then(r=>r.json())
    .then(data=>{
      scheduleData=JSON.parse(JSON.stringify(data.locations));
      originalData=JSON.parse(JSON.stringify(scheduleData));
      renderSchedule();
      document.getElementById('editBtn').classList.remove('hidden');
    })
    .catch(err=>{
      console.error('Napaka pri nalaganju JSON:',err);
      document.getElementById('scheduleDisplay').textContent='Napaka pri nalaganju urnikov.';
    });
}

function renderSchedule(){
  const container=document.getElementById('scheduleDisplay');
  container.innerHTML='';
  Object.entries(scheduleData).forEach(([loc,locData])=>{
    const card=document.createElement('div');
    card.className='border rounded p-4 bg-gray-50';
    const title=document.createElement('h3');
    title.className='font-semibold text-lg mb-2';
    title.textContent=loc;
    card.appendChild(title);
    locData.periods.forEach((p,idx)=>{
      const periodDiv=document.createElement('div');
      periodDiv.className='border p-2 rounded mb-2 bg-white';
      periodDiv.innerHTML=`<strong>Obdobje ${idx+1}:</strong> ${p.start} - ${p.end}`;
      const ul=document.createElement('ul');
      for(const day in p.hours){
        const li=document.createElement('li');
        const val=p.hours[day];
        li.textContent=`${dayNames[day]}: ${Array.isArray(val)?val.join(', '):(val||'Zaprto')}`;
        ul.appendChild(li);
      }
      periodDiv.appendChild(ul);
      card.appendChild(periodDiv);
    });
    container.appendChild(card);
  });
}

function startEditing(){
  const editor=document.getElementById('editor');
  const list=document.getElementById('periodList');
  list.innerHTML='';
  Object.entries(scheduleData).forEach(([loc,locData])=>{
    const locCard=document.createElement('div');
    locCard.className='border rounded p-3 bg-gray-100';
    const title=document.createElement('h4');
    title.className='font-semibold mb-2';
    title.textContent=loc;
    locCard.appendChild(title);
    locData.periods.forEach((p,idx)=>{
      locCard.appendChild(createPeriodForm(loc,idx,p));
    });
    const addBtn=document.createElement('button');
    addBtn.textContent='Dodaj obdobje';
    addBtn.className='mt-2 bg-blue-500 text-white px-3 py-1 rounded';
    addBtn.onclick=()=>{
      const newPeriod={start:'',end:'',hours:{Mon:null,Tue:null,Wed:null,Thu:null,Fri:null,Sat:null,Sun:null}};
      scheduleData[loc].periods.push(newPeriod);
      locCard.insertBefore(createPeriodForm(loc,scheduleData[loc].periods.length-1,newPeriod),addBtn);
    };
    locCard.appendChild(addBtn);
    list.appendChild(locCard);
  });
  editor.classList.remove('hidden');
}

function createPeriodForm(loc,idx,periodData){
  const div=document.createElement('div');
  div.className='border p-2 rounded mb-2 bg-white';

  const dateDiv=document.createElement('div');
  dateDiv.className='flex flex-col sm:flex-row gap-2 mb-2';
  const startInput=document.createElement('input');
  startInput.type='date'; startInput.value=periodData.start||''; startInput.className='border p-1 rounded flex-1';
  startInput.onchange=e=>periodData.start=e.target.value;
  const endInput=document.createElement('input');
  endInput.type='date'; endInput.value=periodData.end||''; endInput.className='border p-1 rounded flex-1';
  endInput.onchange=e=>periodData.end=e.target.value;
  dateDiv.appendChild(startInput); dateDiv.appendChild(endInput);
  div.appendChild(dateDiv);

  const removeBtn=document.createElement('button');
  removeBtn.textContent='Odstrani obdobje';
  removeBtn.className='mb-2 bg-red-500 text-white px-2 py-1 rounded';
  removeBtn.onclick=()=>{scheduleData[loc].periods.splice(idx,1);div.remove();renderSchedule();};
  div.appendChild(removeBtn);

  Object.keys(periodData.hours).forEach(day=>{
    const dayDiv=document.createElement('div');
    dayDiv.className='flex flex-col sm:flex-row gap-2 items-start mt-1 sm:items-center';
    const label=document.createElement('span');
    label.textContent=dayNames[day]+':';
    label.className='w-16 flex-shrink-0 font-medium';
    dayDiv.appendChild(label);

    const rangesWrap=document.createElement('div');
    rangesWrap.className='flex flex-wrap gap-2 flex-1';
    let ranges=[];
    const raw=periodData.hours[day];
    if(raw===null||raw===undefined) ranges=[];
    else if(Array.isArray(raw)) ranges=raw.map(x=>String(x).trim()).filter(x=>x);
    else ranges=String(raw).split(',').map(x=>x.trim()).filter(x=>x);

    function addRange(value=''){
      if(rangesWrap.children.length>=2) return;
      const pair=document.createElement('div');
      pair.className='flex gap-1 items-center';
      const from=document.createElement('input'); from.type='time'; from.className='border p-1 rounded';
      const to=document.createElement('input'); to.type='time'; to.className='border p-1 rounded';
      const m=value.match(/(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})/);
      if(m){from.value=m[1];to.value=m[2];}
      const remove=document.createElement('button'); remove.textContent='X'; remove.className='ml-2 bg-red-400 text-white px-2 py-1 rounded';
      remove.onclick=()=>{pair.remove();updateBacking();updateAddBtn();};
      function updateBacking(){
        const vals=[];
        rangesWrap.querySelectorAll(':scope > div').forEach(pdiv=>{
          const tfrom=pdiv.querySelectorAll('input')[0].value;
          const tto=pdiv.querySelectorAll('input')[1].value;
          if(tfrom&&tto) vals.push(tfrom+'-'+tto);
        });
        periodData.hours[day]=vals.length===0?null:(vals.length===1?vals:vals);
        renderSchedule();
      }
      from.onchange=to.onchange=updateBacking;
      pair.appendChild(from); pair.appendChild(to); pair.appendChild(remove);
      rangesWrap.appendChild(pair);
      updateBacking(); updateAddBtn();
    }

    if(ranges.length===0) addRange('');
    else ranges.forEach(r=>addRange(r));

    const addBtn=document.createElement('button');
    addBtn.textContent='+';
    addBtn.className='ml-2 bg-blue-400 text-white px-2 py-1 rounded';
    addBtn.onclick=()=>addRange('');
    function updateAddBtn(){addBtn.style.display=rangesWrap.children.length>=2?'none':'inline-block';}
    updateAddBtn();

    dayDiv.appendChild(rangesWrap);
    dayDiv.appendChild(addBtn);
    div.appendChild(dayDiv);

    // helper text
    const helper=document.createElement('p');
    helper.className='text-gray-500 text-sm mb-1';
    helper.textContent='Vnesite 1 ali 2 časovna obdobja (npr. 09:00-12:00, 17:00-21:00)';
    div.appendChild(helper);
  });

  return div;
}

function cancelEditing(){document.getElementById('editor').classList.add('hidden');}
function saveChanges(){renderSchedule();alert('Spremembe uporabljene (samo za prikaz, še niso shranjene).');cancelEditing();}
</script>
</body>
</html>
