<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Urejanje urnikov</title>
</head>
<body class="bg-gray-100 p-4 flex flex-col items-center">

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="w-full max-w-sm mt-10 bg-white shadow-md rounded-xl p-6">
    <h2 class="text-xl font-semibold mb-4 text-center">Prijava</h2>
    <label class="block mb-2">Uporabniško ime</label>
    <input id="username" class="w-full p-2 border rounded mb-4" placeholder="Vnesi uporabniško ime" />

    <label class="block mb-2">Geslo</label>
    <input id="password" type="password" class="w-full p-2 border rounded mb-6" placeholder="Vnesi geslo" />

    <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Prijava</button>
    <p id="loginMsg" class="text-red-600 mt-2"></p>
  </div>

  <!-- MAIN PAGE -->
  <div id="mainPage" class="hidden w-full max-w-4xl mt-10 bg-white shadow-md rounded-xl p-6">
    <h2 class="text-2xl font-bold mb-4">Urejanje urnikov</h2>

    <div id="scheduleDisplay" class="space-y-4"></div>

    <button id="editBtn" onclick="startEditing()" class="mt-4 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 hidden">Uredi urnik</button>

    <!-- Editor -->
    <div id="editor" class="hidden mt-6">
      <h3 class="text-xl font-semibold mb-4">Uredi obdobja</h3>
      <div id="periodList" class="space-y-4"></div>
      <button onclick="addPeriod()" class="mt-4 bg-blue-600 text-white py-2 px-4 rounded">Dodaj obdobje</button>

      <div class="flex gap-3 mt-6">
        <button onclick="cancelEditing()" class="flex-1 bg-gray-400 text-white py-2 rounded">Prekliči</button>
        <button onclick="saveChanges()" class="flex-1 bg-green-600 text-white py-2 rounded">Uporabi spremembe (samo za prikaz)</button>
      </div>
    </div>
  </div>

<script>
/* maps and state */
const dayNamesSlShort = { Mon: "Pon", Tue: "Tor", Wed: "Sre", Thu: "Čet", Fri: "Pet", Sat: "Sob", Sun: "Ned" };
const currentYear = new Date().getFullYear();
let scheduleData = {};
let originalData = null;

/* login + load */
function login() {
  const user = document.getElementById('username').value;
  const pass = document.getElementById('password').value;
  const msg = document.getElementById('loginMsg');

  if (user === 'admin' && pass === 'admin') {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    loadJSON();
  } else {
    msg.textContent = 'Neveljavni podatki (uporabite admin/admin).';
  }
}

function loadJSON() {
  fetch('status-muzeja/schedules.json')
    .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
    .then(data => {
      scheduleData = JSON.parse(JSON.stringify(data.locations || {}));
      originalData = JSON.parse(JSON.stringify(scheduleData));
      renderSchedule();
      document.getElementById('editBtn').classList.remove('hidden');
    })
    .catch(err => {
      console.error('Napaka pri nalaganju JSON:', err);
      document.getElementById('scheduleDisplay').textContent = 'Napaka pri nalaganju urnikov.';
    });
}

/* preview */
function renderSchedule() {
  const container = document.getElementById('scheduleDisplay');
  container.innerHTML = '';
  Object.entries(scheduleData).forEach(([loc, locData]) => {
    const card = document.createElement('div'); card.className = 'border rounded p-4 bg-gray-50';
    const title = document.createElement('h3'); title.className = 'font-semibold text-lg mb-2'; title.textContent = loc; card.appendChild(title);

    (locData.periods || []).forEach((p, idx) => {
      const periodDiv = document.createElement('div'); periodDiv.className = 'border p-2 rounded mb-2 bg-white';
      periodDiv.innerHTML = `<strong>Obdobje ${idx+1}:</strong> ${p.start || '—'} - ${p.end || '—'}`;
      const ul = document.createElement('ul');
      for (const dayKey of ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']) {
        const li = document.createElement('li');
        const val = p.hours ? p.hours[dayKey] : null;
        const display = Array.isArray(val) ? val.join(', ') : (val || 'Zaprto');
        li.textContent = `${dayNamesSlShort[dayKey]}: ${display}`;
        ul.appendChild(li);
      }
      periodDiv.appendChild(ul); card.appendChild(periodDiv);
    });

    container.appendChild(card);
  });
}

/* editor */
function startEditing() {
  const editor = document.getElementById('editor');
  const list = document.getElementById('periodList');
  list.innerHTML = '';

  Object.entries(scheduleData).forEach(([loc, locData]) => {
    const locCard = document.createElement('div'); locCard.className = 'border rounded p-3 bg-gray-100';
    const title = document.createElement('h4'); title.className = 'font-semibold mb-2'; title.textContent = loc; locCard.appendChild(title);

    (locData.periods || []).forEach((p, idx) => locCard.appendChild(createPeriodForm(loc, idx, p)));

    const addBtn = document.createElement('button'); addBtn.textContent = 'Dodaj obdobje'; addBtn.className = 'mt-2 bg-blue-500 text-white px-3 py-1 rounded';
    addBtn.onclick = () => {
      const newPeriod = { start:'', end:'', hours:{ Mon:null,Tue:null,Wed:null,Thu:null,Fri:null,Sat:null,Sun:null } };
      scheduleData[loc].periods.push(newPeriod);
      locCard.insertBefore(createPeriodForm(loc, scheduleData[loc].periods.length-1, newPeriod), addBtn);
      sortPeriods(loc);
    };
    locCard.appendChild(addBtn);

    list.appendChild(locCard);
  });

  editor.classList.remove('hidden');
}

/* date helpers */
function mmddToDateValue(mmdd) { if (!mmdd || !/^\d{2}-\d{2}$/.test(mmdd)) return ''; return `${currentYear}-${mmdd}`; }
function dateValueToMmdd(v) { if (!v || v.length < 10) return ''; return v.slice(5); }

/* create period form — now pre-populates existing hours into time inputs, adds helper text and "Obdobje od ... do ..." layout */
function createPeriodForm(loc, idx, periodData) {
  const div = document.createElement('div'); div.className = 'border p-2 rounded mb-2 bg-white';

  // helper text above pickers
  const helper = document.createElement('div'); helper.className = 'text-sm text-gray-600 mb-2'; helper.textContent = 'Izberi ali vpiši datum'; div.appendChild(helper);

  // Date range line: Obdobje od (picker + MM-DD) do (picker + MM-DD)
  const dateRow = document.createElement('div'); dateRow.className = 'flex gap-2 items-center mb-2 flex-col sm:flex-row w-full';
  const startWrap = document.createElement('div'); startWrap.className = 'flex items-center gap-2';
  const startLabel = document.createElement('div'); startLabel.className = 'font-medium'; startLabel.textContent = 'Obdobje od';
  const startDate = document.createElement('input'); startDate.type='date'; startDate.className='border p-1 rounded'; startDate.value = mmddToDateValue(periodData.start);
  const startText = document.createElement('input'); startText.type='text'; startText.placeholder='MM-DD'; startText.className='border p-1 rounded w-24'; startText.value = periodData.start || '';
  startWrap.appendChild(startLabel); startWrap.appendChild(startDate); startWrap.appendChild(startText);

  const middle = document.createElement('div'); middle.textContent = 'do'; middle.className='mx-2 font-medium';

  const endWrap = document.createElement('div'); endWrap.className = 'flex items-center gap-2';
  const endDate = document.createElement('input'); endDate.type='date'; endDate.className='border p-1 rounded'; endDate.value = mmddToDateValue(periodData.end);
  const endText = document.createElement('input'); endText.type='text'; endText.placeholder='MM-DD'; endText.className='border p-1 rounded w-24'; endText.value = periodData.end || '';
  endWrap.appendChild(endDate); endWrap.appendChild(endText);

  // sync datepicker <-> mm-dd text for start/end
  startDate.onchange = (e) => { const mmdd = dateValueToMmdd(e.target.value); periodData.start = mmdd; startText.value = mmdd; sortPeriods(loc); };
  startText.onchange = (e) => {
    const v = e.target.value.trim();
    if (/^\d{2}-\d{2}$/.test(v)) { periodData.start = v; startDate.value = mmddToDateValue(v); sortPeriods(loc); }
    else { if (v === '') { periodData.start=''; startDate.value=''; } else { alert('Vnesite datum v formatu MM-DD (npr. 07-01) ali uporabite koledar.'); startText.value = periodData.start || ''; } }
  };
  endDate.onchange = (e) => { const mmdd = dateValueToMmdd(e.target.value); periodData.end = mmdd; endText.value = mmdd; sortPeriods(loc); };
  endText.onchange = (e) => {
    const v = e.target.value.trim();
    if (/^\d{2}-\d{2}$/.test(v)) { periodData.end = v; endDate.value = mmddToDateValue(v); sortPeriods(loc); }
    else { if (v === '') { periodData.end=''; endDate.value=''; } else { alert('Vnesite datum v formatu MM-DD (npr. 08-31) ali uporabite koledar.'); endText.value = periodData.end || ''; } }
  };

  dateRow.appendChild(startWrap);
  dateRow.appendChild(middle);
  dateRow.appendChild(endWrap);
  div.appendChild(dateRow);

  // Remove period button (placed after date row for clarity)
  const removeBtn = document.createElement('button'); removeBtn.textContent='Odstrani obdobje'; removeBtn.className='mt-2 bg-red-500 text-white px-3 py-1 rounded';
  removeBtn.onclick = () => { const arr = scheduleData[loc].periods; const i = arr.indexOf(periodData); if (i>=0) { arr.splice(i,1); div.remove(); } else div.remove(); };
  div.appendChild(removeBtn);

  // Hours area — prepopulate existing data into time inputs
  const hoursBox = document.createElement('div'); hoursBox.className='mt-3 space-y-2';
  const dayKeys = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

  dayKeys.forEach(dayKey => {
    const row = document.createElement('div'); row.className='flex flex-col md:flex-row md:items-center gap-2';
    const lbl = document.createElement('div'); lbl.className='w-20 font-medium'; lbl.textContent = dayNamesSlShort[dayKey] + ':';
    const rangesWrap = document.createElement('div'); rangesWrap.className='flex gap-2 flex-wrap items-center flex-1';

    // Normalize existing value (string or array) to array of ranges like "HH:MM-HH:MM"
    const raw = periodData.hours && periodData.hours[dayKey] !== undefined ? periodData.hours[dayKey] : null;
    let ranges = [];
    if (raw === null || raw === undefined) ranges = [];
    else if (Array.isArray(raw)) ranges = raw.map(x=>String(x).trim()).filter(x=>x);
    else ranges = String(raw).split(',').map(x=>x.trim()).filter(x=>x);

    function addRangePair(initial='') {
      let fromVal='', toVal='';
      const m = String(initial).match(/(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})/);
      if (m) { fromVal = m[1]; toVal = m[2]; }

      const pair = document.createElement('div'); pair.className='flex gap-1 items-center';
      const from = document.createElement('input'); from.type='time'; from.className='border p-1 rounded'; from.value = fromVal;
      const dash = document.createElement('span'); dash.textContent='–'; dash.className='px-1';
      const to = document.createElement('input'); to.type='time'; to.className='border p-1 rounded'; to.value = toVal;
      const removeRange = document.createElement('button'); removeRange.className='ml-2 bg-red-400 text-white px-2 py-1 rounded'; removeRange.textContent='X';

      function updateBacking() {
        const vals = [];
        const pairs = rangesWrap.querySelectorAll(':scope > div'); // direct children pairs
        pairs.forEach(pdiv => {
          const tfrom = pdiv.querySelector('input[type=time]');
          const tto = pdiv.querySelectorAll('input[type=time]')[1];
          if (tfrom && tto && tfrom.value && tto.value) vals.push(tfrom.value + '-' + tto.value);
        });
        periodData.hours[dayKey] = vals.length === 0 ? null : (vals.length === 1 ? vals[0] : vals);
        renderSchedule(); // update preview live
      }

      removeRange.onclick = () => { pair.remove(); updateBacking(); };
      from.onchange = updateBacking; to.onchange = updateBacking;

      pair.appendChild(from); pair.appendChild(dash); pair.appendChild(to); pair.appendChild(removeRange);
      rangesWrap.appendChild(pair);
      updateBacking();
    }

    // populate existing ranges: if none, show one empty pair as guidance
    if (ranges.length === 0) addRangePair('');
    else ranges.forEach(r => addRangePair(r));

    const addBtn = document.createElement('button'); addBtn.className='ml-2 bg-blue-400 text-white px-2 py-1 rounded'; addBtn.textContent='+'; addBtn.onclick = () => addRangePair('');

    row.appendChild(lbl); row.appendChild(rangesWrap); row.appendChild(addBtn);
    hoursBox.appendChild(row);
  });

  div.appendChild(hoursBox);
  return div;
}

/* sort periods and helpers */
function sortPeriods(loc) {
  const arr = scheduleData[loc].periods;
  arr.sort((a,b) => { if (!a.start && !b.start) return 0; if (!a.start) return 1; if (!b.start) return -1; return a.start.localeCompare(b.start); });
  renderSchedule();
}

/* cancel / save (mock) */
function cancelEditing() { scheduleData = JSON.parse(JSON.stringify(originalData)); document.getElementById('editor').classList.add('hidden'); renderSchedule(); }
function saveChanges() { originalData = JSON.parse(JSON.stringify(scheduleData)); Object.keys(scheduleData).forEach(loc=>sortPeriods(loc)); renderSchedule(); alert('Spremembe uporabljene (samo za prikaz, še niso shranjene).'); document.getElementById('editor').classList.add('hidden'); }

/* add period helper */
function addPeriod() {
  const firstLoc = Object.keys(scheduleData)[0];
  if (!firstLoc) { alert('Ni lokacij v podatkih (ne morem dodati obdobja).'); return; }
  const newPeriod = { start:'', end:'', hours:{ Mon:null,Tue:null,Wed:null,Thu:null,Fri:null,Sat:null,Sun:null } };
  scheduleData[firstLoc].periods.push(newPeriod);
  startEditing();
}
</script>
</body>
</html>
