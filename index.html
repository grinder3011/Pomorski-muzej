<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <title>Muzej delovni čas</title>
  <style>
    body {
      margin:0; padding:0;
      font-family: Arial, sans-serif;
      background: #222;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      user-select: none;
    }

    #status {
      width: 280px;
      height: 140px;
      border-radius: 20px;
      font-size: 2.5rem;
      font-weight: 700;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      text-transform: uppercase;
      animation: blink 2s infinite;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
      margin-bottom: 15px;
    }

    #status.open {
      background-color: #28a745; /* green */
      box-shadow: 0 0 25px #28a745;
    }

    #status.closed {
      background-color: #d32f2f; /* red */
      box-shadow: 0 0 25px #d32f2f;
    }

    #hours {
      font-size: 1.1rem;
      text-align: center;
      max-width: 280px;
      line-height: 1.3;
    }

    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0.6; }
    }
  </style>
</head>
<body>

  <div id="status" class="closed">Zaprto</div>
  <div id="hours">Nalaganje urnika...</div>

<script>
(async () => {
  // Helper to parse time "HH:MM"
  function parseTime(t) {
    const [h,m] = t.split(':').map(Number);
    return h * 60 + m;
  }

  // Check if current time is in interval(s)
  function isOpenNow(hours) {
    if (!hours) return false;
    if (typeof hours === 'string') {
      hours = [hours];
    }
    const now = new Date();
    const currentMinutes = now.getHours()*60 + now.getMinutes();

    return hours.some(interval => {
      const [start, end] = interval.split('-').map(parseTime);
      return currentMinutes >= start && currentMinutes < end;
    });
  }

  // Format today's hours for display
  function formatHours(hours) {
    if (!hours) return "Danes zaprto";
    if (typeof hours === 'string') return hours.replace('-', '–');
    if (Array.isArray(hours)) return hours.map(h => h.replace('-', '–')).join(', ');
    return "";
  }

  // Convert month-day to a Date object (year doesn't matter, just for comparison)
  function monthDayToDate(str) {
    const [m, d] = str.split('-').map(Number);
    // Use current year but will handle year wrap below
    const now = new Date();
    return new Date(now.getFullYear(), m-1, d);
  }

  // Check if date is in period (consider period may cross year boundary)
  function inPeriod(now, startStr, endStr) {
    const year = now.getFullYear();
    let start = new Date(year, ...startStr.split('-').map(x => Number(x)-1));
    let end = new Date(year, ...endStr.split('-').map(x => Number(x)-1));

    // If end < start, period crosses new year
    if (end < start) {
      if (now < start) {
        start.setFullYear(year-1);
      } else {
        end.setFullYear(year+1);
      }
    }
    return now >= start && now <= end;
  }

  // Map JS getDay() to our keys in JSON
  const daysMap = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  const params = new URLSearchParams(window.location.search);
  const locParam = params.get('loc');
  if (!locParam) {
    document.getElementById('hours').innerText = "Lokacija ni podana";
    return;
  }

  // Load JSON schedule
  const response = await fetch('./status-muzeja/schedule.json');
  const data = await response.json();

  const locData = data.locations[locParam];
  if (!locData) {
    document.getElementById('hours').innerText = "Lokacija ni najdena";
    return;
  }

  const now = new Date();
  const dayKey = daysMap[now.getDay()];

  // Find the current active period for today
  const currentPeriod = locData.periods.find(p => inPeriod(now, p.start, p.end));
  if (!currentPeriod) {
    document.getElementById('hours').innerText = "Danes zaprto";
    return;
  }

  const todayHours = currentPeriod.hours[dayKey] || null;
  const open = isOpenNow(todayHours);

  const statusDiv = document.getElementById('status');
  const hoursDiv = document.getElementById('hours');

  if (open) {
    statusDiv.classList.remove('closed');
    statusDiv.classList.add('open');
    statusDiv.textContent = "ODPRTO";
  } else {
    statusDiv.classList.remove('open');
    statusDiv.classList.add('closed');
    statusDiv.textContent = "ZAPRTO";
  }

  hoursDiv.textContent = "Danes: " + formatHours(todayHours);

})();
</script>

</body>
</html>
